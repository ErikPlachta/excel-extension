<pre class="queries-debug-state">{{ debugState | json }}</pre>

<app-section
  title="API Catalog"
  subtitle="Choose an API and define per-workbook selected queries."
  variant="dense"
>
  <app-table
    [columns]="[
      { field: 'id', header: 'Id' },
      { field: 'name', header: 'Name' },
      { field: 'description', header: 'Description' },
    ]"
    [rows]="apis"
    emptyMessage="No APIs available."
  ></app-table>
</app-section>

<app-section
  title="Add selected query for this workbook"
  subtitle="Bind an API to a target sheet/table and write mode."
  variant="dense"
>
  <div class="query-add-form">
    <label>
      API
      <app-dropdown
        [items]="addApiItems"
        [value]="selectedApiId"
        placeholder="Choose API"
        (valueChange)="onSelectedApiChange($event)"
      ></app-dropdown>
    </label>

    <label>
      Display name
      <input type="text" [(ngModel)]="newDisplayName" />
    </label>

    <label>
      Target sheet name
      <input type="text" [(ngModel)]="newTargetSheetName" />
    </label>

    <label>
      Target table name
      <input type="text" [(ngModel)]="newTargetTableName" />
    </label>

    <label>
      Write mode
      <select [(ngModel)]="newWriteMode">
        <option value="overwrite">Overwrite</option>
        <option value="append">Append</option>
      </select>
    </label>

    <label> <input type="checkbox" [(ngModel)]="newIncludeInBatch" /> Include in batch runs </label>

    <app-button label="Add selected" [disabled]="!canAddSelected" (clicked)="addSelected()">
    </app-button>
  </div>
</app-section>

<app-section
  title="Selected queries for this workbook"
  subtitle="These configurations will be used for future runs."
  variant="dense"
>
  <app-table
    [columns]="[
      { field: 'displayName', header: 'Display name' },
      { field: 'apiId', header: 'API' },
      { field: 'targetSheetName', header: 'Sheet' },
      { field: 'targetTableName', header: 'Table' },
      { field: 'writeMode', header: 'Write mode' },
    ]"
    [rows]="selectedItems"
    emptyMessage="No selected queries yet."
  ></app-table>

  <ul class="query-actions" *ngIf="selectedItems.length">
    <li
      *ngFor="let item of selectedItems"
      [class.query-actions__item--active]="item.id === queueCurrentItemId"
    >
      <span>{{ item.displayName }} ({{ item.apiId }})</span>
      <app-button
        label="Details"
        variant="secondary"
        size="sm"
        (clicked)="startEdit(item)"
      ></app-button>
    </li>
  </ul>
</app-section>

<app-section
  title="Named configurations"
  subtitle="Save and reuse sets of selected queries for a workbook."
  variant="dense"
>
  <div class="query-config-save">
    <label>
      Configuration name
      <input type="text" [(ngModel)]="configName" />
    </label>

    <app-button
      [label]="isRenaming ? 'Rename configuration' : 'Save configuration'"
      [disabled]="!selectedItems.length"
      (clicked)="saveCurrentConfiguration()"
    ></app-button>

    <app-button
      label="Save as new configuration"
      variant="secondary"
      size="sm"
      [disabled]="!selectedItems.length"
      (clicked)="newConfigurationFromCurrent()"
    ></app-button>
  </div>

  <div class="query-config-list" *ngIf="savedConfigs.length">
    <p>Saved configurations:</p>
    <ul>
      <li *ngFor="let config of savedConfigs">
        <span>
          {{ config.name }}
        </span>
        <app-button
          label="Load"
          variant="secondary"
          size="sm"
          (clicked)="loadConfiguration(config.id)"
        ></app-button>
        <app-button
          label="Rename"
          variant="secondary"
          size="sm"
          (clicked)="startRename(config)"
        ></app-button>
        <app-button
          label="Delete"
          variant="secondary"
          size="sm"
          (clicked)="deleteConfiguration(config.id)"
        ></app-button>
      </li>
    </ul>
  </div>

  <div class="query-config-run" *ngIf="selectedItems.length">
    <app-progress-indicator
      [total]="queueTotal"
      [completed]="queueCompleted"
      [currentItemId]="queueCurrentItemId"
    ></app-progress-indicator>

    <app-button
      label="Run configuration"
      [disabled]="isRunningConfig || !excel.isExcel"
      (clicked)="runCurrentConfiguration()"
    ></app-button>
  </div>
</app-section>

<app-section
  title="Selected query details"
  subtitle="Edit configuration for a single selected query."
  variant="dense"
>
  <p *ngIf="!editingItem">Choose a selected query and click Details to edit.</p>

  <div *ngIf="editingItem" class="query-edit-form">
    <p><strong>Editing:</strong> {{ editingItem.displayName }} ({{ editingItem.apiId }})</p>

    <label>
      Display name
      <input type="text" [(ngModel)]="editingDisplayName" />
    </label>

    <label>
      Target sheet name
      <input type="text" [(ngModel)]="editingTargetSheetName" />
    </label>

    <label>
      Target table name
      <input type="text" [(ngModel)]="editingTargetTableName" />
    </label>

    <label>
      Write mode
      <select [(ngModel)]="editingWriteMode">
        <option value="overwrite">Overwrite</option>
        <option value="append">Append</option>
      </select>
    </label>

    <label>
      <input type="checkbox" [(ngModel)]="editingIncludeInBatch" /> Include in batch runs
    </label>

    <fieldset class="query-edit-params" *ngIf="editingItem">
      <legend>Parameters (per configuration)</legend>
      <label>
        Start Date
        <input type="date" [(ngModel)]="editingParameters.StartDate" />
      </label>
      <label>
        End Date
        <input type="date" [(ngModel)]="editingParameters.EndDate" />
      </label>
      <label>
        Group
        <input type="text" [(ngModel)]="editingParameters.Group" />
      </label>
      <label>
        SubGroup
        <input type="text" [(ngModel)]="editingParameters.SubGroup" />
      </label>
    </fieldset>

    <div class="query-edit-actions">
      <app-button label="Save" (clicked)="saveEdit()"></app-button>
      <app-button
        label="Cancel"
        variant="secondary"
        size="sm"
        (clicked)="cancelEdit()"
      ></app-button>
    </div>
  </div>
</app-section>
